<script>
    let stream = null;
    let bottleCount = 0;
    let canCount = 0;
    let countdownTimer = null;

    const startCameraBtn = document.getElementById('startCamera');
    const captureBtn = document.getElementById('captureBtn');
    const cameraView = document.getElementById('cameraView');
    const resultsContainer = document.getElementById('resultsContainer');
    const imageUpload = document.getElementById('imageUpload');

    // Simulated AI detection results
    const detectionResults = [
        {
            type: 'bottle',
            confidence: 0.95,
            material: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å PET',
            recyclable: true,
            tips: '‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÅ‡∏¢‡∏Å‡∏ù‡∏≤‡∏≠‡∏≠‡∏Å ‡πÉ‡∏™‡πà‡∏ñ‡∏±‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô'
        },
        {
            type: 'can',
            confidence: 0.92,
            material: '‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°',
            recyclable: true,
            tips: '‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡πÉ‡∏™‡πà‡∏ñ‡∏±‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á'
        },
        {
            type: 'bottle',
            confidence: 0.88,
            material: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å HDPE',
            recyclable: true,
            tips: '‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏ñ‡∏≠‡∏î‡∏â‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏Å ‡πÉ‡∏™‡πà‡∏ñ‡∏±‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô'
        }
    ];

    startCameraBtn.addEventListener('click', async () => {
        try {
            // Request camera access
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'environment' // Use back camera on mobile
                }
            });

            // Create video element
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.className = 'w-full h-full object-cover rounded-lg';

            cameraView.innerHTML = '';
            cameraView.appendChild(video);

            startCameraBtn.textContent = 'üü¢ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
            startCameraBtn.disabled = true;
            captureBtn.disabled = false;

        } catch (error) {
            console.error('Camera error:', error);
            let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';

            if (error.name === 'NotAllowedError') {
                errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
            } else if (error.name === 'NotFoundError') {
                errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
            } else if (error.name === 'NotSupportedError') {
                errorMessage = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á';
            }

            cameraView.innerHTML = `
                <div class="w-full h-full bg-red-50 flex items-center justify-center text-center p-4">
                    <div>
                        <div class="text-4xl mb-4">‚ùå</div>
                        <p class="text-red-600 font-medium">${errorMessage}</p>
                        <p class="text-sm text-gray-600 mt-2">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ</p>
                    </div>
                </div>
            `;
        }
    });

    captureBtn.addEventListener('click', () => {
        if (stream) {
            // Capture frame from video stream
            const video = cameraView.querySelector('video');
            if (video) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // Show captured image
                const capturedImage = canvas.toDataURL('image/jpeg');
                cameraView.innerHTML = `
                    <img src="${capturedImage}" class="w-full h-full object-cover rounded-lg">
                `;

                // Stop camera stream
                stream.getTracks().forEach(track => track.stop());
                stream = null;

                // Reset buttons
                startCameraBtn.textContent = 'üé• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                startCameraBtn.disabled = false;
                captureBtn.disabled = true;
            }
        }

        simulateDetection();
    });

    imageUpload.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                cameraView.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">
                `;
                setTimeout(() => simulateDetection(), 1000);
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function simulateDetection() {
        // Show processing
        resultsContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="animate-spin text-4xl mb-4">üîÑ</div>
                <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û...</p>
            </div>
        `;

        // Simulate the detection delay
        setTimeout(() => {
            const result = detectionResults[Math.floor(Math.random() * detectionResults.length)];
            displayResult(result);
            updateStats(result.type);
            startCountdown();
        }, 2000);
    }

    function displayResult(result) {
        const isBottle = result.type === 'bottle';
        const icon = isBottle ? 'üçº' : 'ü•§';
        const bgColor = isBottle ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200';
        const textColor = isBottle ? 'text-blue-800' : 'text-orange-800';
        const confidence = Math.round(result.confidence * 100);

        resultsContainer.innerHTML = `
            <div class="result-card ${bgColor} border-2 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3">${icon}</span>
                        <div>
                            <h3 class="text-xl font-semibold ${textColor}">
                                ${isBottle ? '‡∏Ç‡∏ß‡∏î‡∏ô‡πâ‡∏≥' : '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á'}
                            </h3>
                            <p class="text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${confidence}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center">
                        <span class="font-medium text-gray-700 w-20">‡∏ß‡∏±‡∏™‡∏î‡∏∏:</span>
                        <span class="text-gray-600">${result.material}</span>
                    </div>
                    
                    <div class="flex items-center">
                        <span class="font-medium text-gray-700 w-20">‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•:</span>
                        <span class="text-green-600 font-medium">‚úÖ ‡πÑ‡∏î‡πâ</span>
                    </div>
                    
                    <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h4 class="font-medium text-green-800 mb-2">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•:</h4>
                        <p class="text-green-700 text-sm">${result.tips}</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button onclick="simulateDetection()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                    üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        `;
    }

    function updateStats(type) {
        if (type === 'bottle') {
            bottleCount++;
            document.getElementById('bottleCount').textContent = bottleCount;
        } else {
            canCount++;
            document.getElementById('canCount').textContent = canCount;
        }
    }

    function startCountdown() {
        // Display countdown message
        resultsContainer.innerHTML += `
            <div class="text-center text-gray-600 py-4">
                <p>‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏Å‡∏Ç‡∏ß‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û...</p>
                <p id="countdown">5</p>
            </div>
        `;
        
        let countdown = 5;
        countdownTimer = setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown === 0) {
                clearInterval(countdownTimer);
                captureBtn.click(); // Automatically trigger capture after countdown
            }
        }, 1000);
    }
</script>
